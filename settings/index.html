<!DOCTYPE html>
<html>
  <head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
  </head>
  <body>
    <header class="homey-header">
      <h1 class="homey-title" data-i18n="settings.title">
        <!-- This will be filled with the translated string with key 'settings.title'. -->
      </h1>
      <p class="homey-subtitle" data-i18n="settings.subtitle">
        <!-- This field will also be translated -->
      </p>
    </header>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend" data-i18n="settings.grouptitle">Modbus TCP Settings</legend>

      <div class="homey-form-group">
        <label class="homey-form-label" for="host" data-i18n="settings.host">Host</label>
        <input class="homey-form-input" id="host" type="text" value="" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="port" data-i18n="settings.port">Port</label>
        <input class="homey-form-input" id="port" type="number" value="502" />
      </div>
      <div class="homey-form-group"></div>
        <label class="homey-form-label" for="unit" data-i18n="settings.unit">Unit ID</label>
        <input class="homey-form-input" id="unit" type="number" value="1" />
      </div>
    </fieldset>

    <button id="save" class="homey-button-primary-full" data-i18n="settings.save">Save changes</button>

    <script type="text/javascript">
      // a method named 'onHomeyReady' must be present in your code
      function onHomeyReady(Homey) {
        // Tell Homey we're ready to be displayed
        Homey.ready();

        var hostElement = document.getElementById("host");
        var portElement = document.getElementById("port");
        var unitElement = document.getElementById("unit");
        var saveElement = document.getElementById("save");

        Homey.get("modbushost", function (err, host) {
          if (err) return Homey.alert(err);
          hostElement.value = host;
        });

        Homey.get("modbusport", function (err, port) {
          if (err) return Homey.alert(err);
          portElement.value = port;
        });

        Homey.get("modbusunitid", function (err, unit) {
          if (err) return Homey.alert(err);
          unitElement.value = unit;
        });

        saveElement.addEventListener("click", function (e) {
          if(!checkIp(hostElement.value))
          {
            return Homey.alert(Homey.__("settings.invalidip"));
          }

          Homey.set("modbushost", hostElement.value, function (err) {
            if (err) return Homey.alert(err);
          });
          Homey.set("modbusport", portElement.value, function (err) {
            if (err) return Homey.alert(err);
          });
          Homey.set("modbusunitid", unitElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.log('Huawei Modbus TCP has been configured');
          Homey.log('Huawei Modbus host ' + hostElement.value);
          Homey.log('Huawei Modbus port ' + portElement.value);
          Homey.log('Huawei Modbus unit id ' + unitElement.value);

          Homey.ready();
        });
      }

      function checkIp(ip) {
        const ipv4 = 
            /^(\d{1,3}\.){3}\d{1,3}$/;
        const ipv6 = 
            /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;
        return ipv4.test(ip) || ipv6.test(ip);
    }
    </script>
  </body>
</html>